name: è‡ªåŠ¨éƒ¨ç½² Next.js åˆ°è…¾è®¯äº‘

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. ä¸‹è½½ä»£ç 
    - name: Checkout
      uses: actions/checkout@v3

    # 2. SSR éƒ¨ç½²ï¼šSSH åˆ°æœåŠ¡å™¨æ‰§è¡Œéƒ¨ç½²
    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        script_stop: true  # ä»»ä½•å‘½ä»¤å¤±è´¥æ—¶åœæ­¢
        script: |
          set -e  # ä»»ä½•å‘½ä»¤å¤±è´¥æ—¶é€€å‡º

          echo "ðŸ“ Changing to project directory..."
          cd /www/wwwroot/boluopets.com

          echo "ðŸ” Current git status before pull:"
          git status

          echo "ðŸ“¥ Pulling latest code..."
          git fetch origin
          git reset --hard origin/main  # ä½¿ç”¨ reset ç¡®ä¿å®Œå…¨åŒæ­¥

          echo "ðŸ“Œ Current commit:"
          git log -1 --oneline

          echo "ðŸ“¦ Installing dependencies..."
          npm install --legacy-peer-deps

          echo "ðŸ”¨ Building project..."
          npm run build

          echo "ðŸ›‘ Stopping PM2..."
          pm2 delete blog-website || echo "PM2 service not found"

          echo "ðŸ§¹ Cleaning up port 3000..."
          # å°è¯•æ€æŽ‰å ç”¨ 3000 ç«¯å£çš„åƒµå°¸è¿›ç¨‹ (å¦‚æžœæ²¡æœ‰è¿›ç¨‹å ç”¨ï¼Œå¿½ç•¥é”™è¯¯)
          lsof -ti:3000 | xargs -r kill -9 2>/dev/null || true

          echo "ðŸš€ Starting PM2..."
          pm2 start npm --name "blog-website" -- start

          pm2 save

          echo "âœ… Deployment successful!"
          pm2 status

