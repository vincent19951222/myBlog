name: 自动部署 Next.js 到腾讯云

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. 下载代码
    - name: Checkout
      uses: actions/checkout@v3

    # 2. 准备环境
    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    # 3. 安装依赖并构建
    - name: Install and Build
      run: |
        npm install --legacy-peer-deps
        npm run build
      # 注意：现在 build 生成的是 .next 文件夹，而不是 out

    # 4. 上传文件到服务器 (关键变化！)
    - name: Copy files to Server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        debug: true
        use_insecure_cipher: true
        
        # ⭐ 核心变化：上传运行 Node 服务所需的所有文件
        # 不要上传 node_modules (太大)，我们在服务器上安装
        source: "package.json, package-lock.json, next.config.js, public, .next"
        target: "/www/wwwroot/boluopets.com"
        # 注意：这里去掉了 strip_components，因为我们要上传多个文件/文件夹

    # 5. 远程执行命令 (新增步骤！)
    # 文件传过去后，还需要告诉服务器："装一下依赖，然后重启服务"
    - name: Install Dependencies and Restart PM2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        script: |
          cd /www/wwwroot/boluopets.com
          # 安装生产环境依赖 (因为刚才没传 node_modules)
          npm install --production --legacy-peer-deps
          # 重启 PM2 (让更新生效)
          pm2 reload next-blog || pm2 start npm --name "next-blog" -- start