name: è‡ªåŠ¨éƒ¨ç½² Next.js åˆ°è…¾è®¯äº‘

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. ä¸‹è½½ä»£ç 
    - name: Checkout
      uses: actions/checkout@v3

    # 2. SSR éƒ¨ç½²ï¼šSSH åˆ°æœåŠ¡å™¨æ‰§è¡Œéƒ¨ç½²
    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        script_stop: true  # ä»»ä½•å‘½ä»¤å¤±è´¥æ—¶åœæ­¢
        script: |
          set -e  # ä»»ä½•å‘½ä»¤å¤±è´¥æ—¶é€€å‡º

          echo "ğŸ“ Changing to project directory..."
          cd /www/wwwroot/boluopets.com

          echo "ğŸ” Current git status before pull:"
          git status

          echo "ğŸ“¥ Pulling latest code..."
          git fetch origin
          git reset --hard origin/main  # ä½¿ç”¨ reset ç¡®ä¿å®Œå…¨åŒæ­¥

          echo "ğŸ“Œ Current commit:"
          git log -1 --oneline

          echo "ğŸ“¦ Installing dependencies..."
          npm install --legacy-peer-deps

          echo "ğŸ”¨ Building project..."
          npm run build

          echo "ğŸš€ Restarting PM2..."
          pm2 restart blog-website ||
          pm2 start npm --name "blog-website" -- start

          pm2 save

          echo "âœ… Deployment successful!"
          pm2 status

