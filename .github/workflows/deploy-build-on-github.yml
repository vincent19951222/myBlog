name: è‡ªåŠ¨éƒ¨ç½² Next.js åˆ°è…¾è®¯äº‘ (GitHub æ„å»º)

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. ä¸‹è½½ä»£ç 
    - name: Checkout
      uses: actions/checkout@v3

    # 2. è®¾ç½® Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 20
        cache: 'npm'

    # 3. å®‰è£…ä¾èµ–
    - name: Install dependencies
      run: npm install --legacy-peer-deps

    # 4. åœ¨ GitHub ä¸Šæ„å»ºï¼ˆå¯è®¿é—® Google Fontsï¼‰
    - name: Build project
      run: npm run build
      env:
        # è¿™é‡Œå¯ä»¥è®¾ç½®ä»»ä½•æ„å»ºæ—¶éœ€è¦çš„ç¯å¢ƒå˜é‡
        NODE_ENV: production

    # 5. åˆ›å»ºéƒ¨ç½²åŒ…ï¼ˆåŒ…å«æ‰€æœ‰è¿è¡Œéœ€è¦çš„æ–‡ä»¶ï¼‰
    - name: Create deployment package
      run: |
        mkdir -p deploy

        # å¤åˆ¶æ„å»ºäº§ç‰©ï¼ˆåŒ…å« API Routerï¼‰
        cp -r .next deploy/

        # å¤åˆ¶ public ç›®å½•ï¼ˆé™æ€èµ„æºï¼‰
        cp -r public deploy/

        # å¤åˆ¶ package é…ç½®ï¼ˆç”¨äºæ£€æŸ¥ä¾èµ–å˜åŒ–ï¼‰
        cp package.json deploy/
        [ -f "package-lock.json" ] && cp package-lock.json deploy/

    # 6. å…ˆåœæ­¢ PM2 å¹¶æ¸…ç†æ—§æ„å»º
    - name: Prepare server for deployment
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        script_stop: true
        script: |
          set -e
          cd /www/wwwroot/boluopets.com

          echo "ğŸ›‘ Stopping PM2..."
          pm2 stop blog-website 2>/dev/null || echo "PM2 not running"

          # æ¸…ç†æ—§çš„æ„å»ºäº§ç‰©ï¼ˆä¿ç•™ node_modules å’Œ .envï¼‰
          echo "ğŸ§¹ Cleaning old build..."
          rm -rf .next
          [ -d "public" ] && rm -rf public

    # 7. ä¼ è¾“æ„å»ºäº§ç‰©åˆ° VPS
    - name: Copy build artifacts to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        source: "deploy/*"
        target: "/www/wwwroot/boluopets.com"
        strip_components: 1

    # 7. å®‰è£…ä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰å¹¶é‡å¯ PM2
    - name: Finalize deployment
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        script_stop: true
        script: |
          set -e
          cd /www/wwwroot/boluopets.com

          # å¦‚æœ package.json æœ‰å˜åŒ–ï¼Œé‡æ–°å®‰è£…ä¾èµ–
          if [ ! -f ".next/BUILD_ID" ] || [ "package.json" -nt "node_modules" ]; then
            echo "ğŸ“¦ Installing dependencies..."
            npm install --legacy-peer-deps
          fi

          echo "ğŸš€ Starting PM2..."
          pm2 restart blog-website ||
          pm2 start npm --name "blog-website" -- start

          pm2 save

          echo "âœ… Deployment successful!"
          pm2 status
