name: è‡ªåŠ¨éƒ¨ç½² Next.js åˆ°è…¾è®¯äº‘

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. ä¸‹è½½ä»£ç  (ç”¨äºæœ¬åœ° lint æ£€æŸ¥ï¼Œå¯é€‰)
    - name: Checkout
      uses: actions/checkout@v3

    # 2. SSR éƒ¨ç½²ï¼šSSH åˆ°æœåŠ¡å™¨æ‰§è¡Œéƒ¨ç½²
    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        script: |
          cd /www/wwwroot/boluopets.com
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          echo "ğŸ“¥ Pulling latest code..."
          git pull origin main
          
          # å®‰è£…ä¾èµ–
          echo "ğŸ“¦ Installing dependencies..."
          npm install --legacy-peer-deps
          
          # æ„å»ºé¡¹ç›®
          echo "ğŸ”¨ Building project..."
          npm run build
          
          # é‡å¯ PM2 è¿›ç¨‹
          echo "ğŸš€ Restarting PM2..."
          pm2 restart blog-website || pm2 start npm --name "blog-website" -- start
          
          # ä¿å­˜ PM2 è¿›ç¨‹åˆ—è¡¨
          pm2 save
          
          echo "âœ… Deployment successful!"
          pm2 status

